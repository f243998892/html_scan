# 组长功能使用说明

## 功能概述

本次更新为扫码录入系统添加了组长功能,主要包括以下三个功能:

### 1. 查看小组产品数量汇总
组长可以查看指定日期范围内,所属小组完成的各产品型号的数量统计。

### 2. 查看指定员工完成的产品数量
组长可以查看指定日期范围内,某个员工(或全部员工)完成的各产品型号数量,同时显示小组总完成数量,方便对比。

### 3. 为新产品分配小组
当出现新产品型号时,该工序的所有组长都有权限将该产品分配给某个小组。

## 数据库结构

系统使用以下关键数据表:

### groups (组别表)
- `id`: 主键
- `group_name`: 组别名称
- `group_description`: 组别描述
- `process_name`: 所属工序(如: 绕线、嵌线、接线等)
- `is_active`: 是否激活

### group_leaders (组长表)
- `id`: 主键
- `group_id`: 关联组别ID
- `leader_name`: 组长姓名
- `is_active`: 是否激活

### product_group_assignments (产品型号分配表)
- `id`: 主键
- `product_model`: 产品型号
- `process_name`: 工序名称
- `group_id`: 分配到的组别ID
- `assigned_by`: 分配人
- `assigned_at`: 分配时间
- `is_active`: 是否激活

## 后端API接口

### 1. 获取组长管理的小组列表
```
GET /api/group-leaders?leader_name={姓名}
```
返回该组长管理的所有小组信息。

### 2. 获取所有组别
```
GET /api/groups?active_only=true
```
返回所有激活的组别列表。

### 3. 组长汇总查询
```
POST /api/group-management/leader-summary
Content-Type: application/json

{
    "group_name": "绕线组",
    "process": "绕线",
    "requester_name": "张三",
    "start_date": "2025-11-01T00:00:00Z",
    "end_date": "2025-11-30T23:59:59Z",
    "employee_name": null  // 可选,为null则查询全部员工
}
```
返回指定小组在日期范围内的产品完成统计。

### 4. 获取未分配产品型号
```
GET /api/group-management/unassigned-products?process={工序名称}
```
返回该工序下未分配给任何小组的产品型号列表。

### 5. 严格分配产品到小组
```
POST /api/group-management/assign-secure
Content-Type: application/json

{
    "group_name": "绕线组",
    "process": "绕线",
    "product_models": ["型号A", "型号B"],
    "requester_name": "张三"
}
```
将产品型号分配给指定小组,会进行权限校验:
- 新产品:该工序的任一组长都可以分配
- 已分配产品:只有目标组的组长或有特殊授权的人可以更改

## 前端使用流程

### 1. 登录系统
使用组长的姓名登录系统(如: 张三)。

### 2. 进入组长功能
在主页点击"组长功能"卡片,进入组长功能界面。

### 3. 查看小组产品汇总
1. 点击"查看汇总情况"
2. 选择要查询的小组(只显示您作为组长的小组)
3. 选择日期范围
4. 点击"查询"按钮
5. 查看各产品型号的完成数量统计

### 4. 查看员工产品数量
1. 在组长功能界面点击"查看汇总情况"
2. 然后可以切换到员工查询(通过返回后选择其他选项)
3. 选择小组
4. 输入员工姓名(可留空查询全部)
5. 选择日期范围
6. 点击"查询"
7. 查看结果,会同时显示该员工完成数和小组总完成数

### 5. 为新产品分配小组
1. 在组长功能界面点击"为产品分配组别"
2. 选择工序
3. 从列表中选择一个或多个未分配的产品型号(按住Ctrl键多选)
4. 选择要分配到的小组(只显示您是组长的小组)
5. 点击"分配小组"
6. 查看分配结果

## 测试说明

### 前置条件
1. 数据库中需要有组别数据(groups表)
2. 需要有组长数据(group_leaders表)
3. 需要有产品数据(products表)
4. 需要有产品型号数据用于测试分配

### 测试数据示例

目前数据库中的测试数据:
- 组长: 张三
- 小组: T电机绕线组 (工序: 绕线)

### 添加测试组长数据
如需添加更多组长用于测试,可执行以下SQL:

```sql
-- 添加一个新的绕线组
INSERT INTO groups (group_name, group_description, process_name, is_active)
VALUES ('手排绕线组', '手排绕线专业组', '绕线', true);

-- 添加组长(假设新组的ID是8)
INSERT INTO group_leaders (group_id, leader_name, is_active)
VALUES (8, '方辉', true);

-- 分配一些产品型号到该组
INSERT INTO product_group_assignments (product_model, process_name, group_id, assigned_by, assigned_at, is_active)
VALUES 
('测试型号A', '绕线', 8, '系统管理员', NOW(), true),
('测试型号B', '绕线', 8, '系统管理员', NOW(), true);
```

## 注意事项

1. **权限控制**: 组长只能查看和管理自己所属小组的数据
2. **产品分配**: 
   - 新产品型号:该工序的所有组长都可以分配
   - 已分配产品:只有目标组长或有特殊权限的人可以修改分配
3. **日期范围**: 统计数据基于产品的工序完成时间
4. **多选支持**: 分配产品时支持批量选择,按住Ctrl键可多选

## 技术实现要点

### 前端
- 使用Bootstrap 5构建界面
- 基于原有的扫码系统架构扩展
- 所有API调用使用fetch
- 支持多选产品型号

### 后端
- FastAPI框架
- PostgreSQL数据库
- 使用RealDictCursor返回字典格式数据
- 实现严格的权限校验逻辑
- 支持批量操作

### 安全性
- 组长权限验证在后端API层实现
- 所有敏感操作都记录操作人信息
- 使用is_active字段实现软删除

## 故障排查

### 前端显示"获取小组数据失败"
- 检查后端API服务是否正常运行
- 检查Nginx配置是否正确代理到后端
- 查看浏览器控制台的网络请求错误信息

### 查询结果为空
- 确认登录用户是否是组长
- 确认选择的日期范围内是否有数据
- 检查product_group_assignments表中是否有正确的分配记录

### 无法分配产品
- 确认用户是否是该工序某个小组的组长
- 检查产品型号是否已经分配给其他组
- 查看后端API返回的具体错误信息

## 维护和扩展

### 添加新组长
```sql
INSERT INTO group_leaders (group_id, leader_name, is_active)
VALUES ({组别ID}, '{组长姓名}', true);
```

### 添加新小组
```sql
INSERT INTO groups (group_name, group_description, process_name, is_active)
VALUES ('{组名}', '{描述}', '{工序名}', true);
```

### 查看所有组长
```sql
SELECT gl.leader_name, g.group_name, g.process_name
FROM group_leaders gl
JOIN groups g ON g.id = gl.group_id
WHERE gl.is_active = TRUE AND g.is_active = TRUE
ORDER BY g.process_name, g.group_name;
```

## 联系方式

如有问题,请联系系统管理员。

