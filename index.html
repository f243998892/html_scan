<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生产扫描系统 v2.1</title>
    <!-- 添加meta标签禁止缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="Tue, 19 Nov 2025 20:50:00 GMT">
    
    <!-- Critical polyfill - must be first! -->
    <script>
        // setImmediate polyfill (CRITICAL - needed by face-api.js)
        if (typeof setImmediate === 'undefined') {
            window.setImmediate = function(fn) { return setTimeout(fn, 0); };
        }
        if (typeof clearImmediate === 'undefined') {
            window.clearImmediate = function(id) { clearTimeout(id); };
        }
        
        // 缓存检测：如果30秒后polyfill仍未定义，说明加载了旧缓存，自动刷新
        window.__POLYFILL_VERSION__ = '2025111901';
        setTimeout(function() {
            if (typeof setImmediate === 'undefined' || typeof clearImmediate === 'undefined') {
                console.error('⚠️ 检测到浏览器缓存了旧版本，正在强制刷新...');
                // 显示提示
                document.body.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-family:Arial;"><h2 style="color:#d9534f;">⚠️ 检测到浏览器缓存问题</h2><p>正在自动刷新...</p><div style="border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;"></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style></div>';
                // 1秒后强制刷新
                setTimeout(function() {
                    location.href = location.pathname + '?t=' + Date.now();
                }, 1000);
            }
        }, 30000);
    </script>
    
    <!-- iOS HTTPS特殊处理 -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 使用本地资源，避免网络问题：先加载 Bootstrap，再加载自定义样式 -->
    <link href="css/bootstrap.min.css?v=5.3.0" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap-icons.css?v=1.1">
    <link rel="stylesheet" href="css/style.css?v=1.2">
    <link rel="stylesheet" href="css/mobile-optimize.css?v=1.0">
    <!-- Select2 用于可搜索的多选框 - 可选加载，如果失败会使用原生多选框 -->
    <!-- 注释掉CDN资源，减少移动端加载时间
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    -->
    
    <!-- PWA支持 -->
    <link rel="manifest" href="./manifest.json?v=1.1">
    <meta name="apple-mobile-web-app-title" content="扫码系统">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png?v=1.1">
    <meta name="theme-color" content="#007bff">
    <style>
        body {
            padding: 10px;
            background-color: #f8f9fa;
            max-width: 850px;
            margin: 0 auto;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
            margin-bottom: 12px;
        }
        .card:hover {
            transform: translateY(-3px);
        }
        .card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .cert-section {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        /* 首页卡片样式优化 */
        .home-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .card-body.p-4 {
            padding: 1rem !important;
        }
        .row.g-3 {
            margin-left: -8px;
            margin-right: -8px;
        }
        .row.g-3 > .col-6 {
            padding-left: 8px;
            padding-right: 8px;
        }
        /* 保证首页图标为两列布局（即使栅格失效也能生效） */
        #home-screen .row.g-3 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            column-gap: 16px;
            row-gap: 16px;
            margin-left: 0;  /* 由gap接管间距 */
            margin-right: 0;
        }
        #home-screen .row.g-3 > [class^="col-"],
        #home-screen .row.g-3 > [class*=" col-"] {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        /* 响应式：大屏改为三列 */
        @media (min-width: 992px) {
            #home-screen .row.g-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        .card-body i {
            font-size: 2.2rem !important;
            margin-bottom: 6px;
        }
        .card-body h5 {
            font-size: 1rem;
            margin-top: 8px !important;
        }
        .row.mb-3 {
            margin-bottom: 12px !important;
        }
        /* 用户信息和退出设置卡片优化 */
        .bg-light .card-body {
            padding: 0.8rem !important;
        }
        /* 优化顶部提示 */
        .alert {
            margin: 10px !important;
            padding: 10px 15px !important;
        }
        .mt-5 {
            margin-top: 1.5rem !important;
        }
        .container {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        /* 确保产品扫码查询的手动输入框始终可见 */
        #manual-input-container {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* 工序选择样式增强 */
        .process-select-container {
            background-color: #f8f0ff; 
            border: 2px solid #8a2be2; 
            border-radius: 8px;
            padding: 10px;
        }
        
        .process-select-container label {
            color: #8a2be2;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        #process-select {
            font-size: 1.25rem;
            font-weight: 600;
            height: auto;
            padding: 10px;
            border: 2px solid #8a2be2;
            background-color: #ffffff;
            color: #8a2be2;
        }
        
        /* 工序名称闪烁效果 */
        .process-highlight {
            animation: process-blink 0.75s infinite;
            font-size: 3rem !important;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        @keyframes process-blink {
            0%, 100% { 
                background-color: #8a2be2; 
                color: white;
                box-shadow: 0 0 10px rgba(138, 43, 226, 0.8);
            }
            50% { 
                background-color: #ff5722; 
                color: white;
                box-shadow: 0 0 15px rgba(255, 87, 34, 0.8);
            }
        }
        
        /* 工序警告样式 - 用于主页显示当前工序 */
        .process-warning {
            position: fixed;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 87, 34, 0.9);
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            max-width: 90%;
        }
        
        /* 扫码页面工序显示样式 */
        .current-process-display {
            background-color: #8a2be2;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
        }
        
        /* Toast提示样式 */
        .custom-toast {
            border-radius: 8px;
            padding: 15px 20px;
            margin: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-weight: bold;
            min-width: 250px;
            text-align: center;
            border: 3px solid white;
            background-color: rgba(0, 0, 0, 0.85) !important;
            color: white !important;
        }

        /* 更新Toast容器位置到屏幕中央 */
        #toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            pointer-events: none;
        }
        /* 避免多层卡片嵌套产生双重边框/阴影 */
        .card .card {
            border: 0 !important;
            box-shadow: none !important;
            margin-bottom: 0 !important;
        }
        /* 列表项内长文本友好换行，避免挤压布局 */
        .list-group-item {
            white-space: normal !important;
            word-break: break-word !important;
            overflow-wrap: anywhere !important;
        }
        
        /* 日期时间筛选区域不换行 */
        .date-time-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .date-time-row > div {
            flex: 1;
            flex-shrink: 0;
            min-width: 180px;
        }
        
        /* 筛选框美化 */
        .filter-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            height: 100%;
            transition: all 0.2s;
        }
        .filter-box:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
        }
        .filter-box label i {
            margin-right: 4px;
        }
        
        /* 在小屏幕上优化日期时间显示 */
        @media (max-width: 768px) {
            .date-time-row > div {
                min-width: 150px;
            }
            .date-time-row .form-label {
                font-size: 0.85rem;
            }
        }
        
        /* Select2 自定义样式 */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container {
            width: 100% !important;
        }
    </style>
</head>
<body>

    
    <!-- 已删除iOS用户提示 - 因为能访问此HTTPS页面的iOS用户已经安装了证书 -->
    
    <div class="container mt-3" id="app">
        <div id="login-screen" class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
            <div class="card shadow-sm" style="width: 100%; max-width: 500px;">
                <!-- 页面加载状态提示 -->
                <div id="page-loading-indicator" class="alert alert-info m-3 mb-0" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="flex-grow-1">
                            <strong>系统初始化中...</strong>
                            <div class="small mt-1" id="loading-status-text">正在加载应用资源</div>
                        </div>
                    </div>
                    <!-- 加载进度条 -->
                    <div class="progress mt-2" style="height: 4px;">
                        <div id="loading-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">👤 人脸识别登录</h3>
                    
                    <!-- 选项卡导航 -->
                    <ul class="nav nav-tabs mb-3" id="loginTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="face-login-tab" data-bs-toggle="tab" data-bs-target="#face-login" type="button" role="tab">
                                <i class="bi bi-person-check"></i> 人脸登录
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="face-register-tab" data-bs-toggle="tab" data-bs-target="#face-register" type="button" role="tab">
                                <i class="bi bi-person-plus"></i> 新用户注册
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 选项卡内容 -->
                    <div class="tab-content" id="loginTabsContent">
                        <!-- 人脸登录标签页 -->
                        <div class="tab-pane fade show active" id="face-login" role="tabpanel">
                            <div class="text-center mb-3">
                                <p class="text-muted">请正视摄像头进行人脸识别</p>
                            </div>
                            
                            <!-- 摄像头预览 -->
                            <div class="position-relative mb-3">
                                <video id="face-login-video" width="100%" height="300" autoplay muted playsinline class="border rounded" style="background-color: #000;"></video>
                                <canvas id="face-login-canvas" class="position-absolute top-0 start-0 w-100 h-100" style="display:none;"></canvas>
                                <div id="face-login-status" class="position-absolute bottom-0 start-0 w-100 text-center py-2 bg-dark bg-opacity-75 text-white" style="display:none;">
                                    初始化中...
                                </div>
                            </div>
                            
                            <button id="face-login-btn" class="btn btn-primary w-100 py-2 mb-2">
                                <i class="bi bi-camera"></i> 开始人脸识别登录
                            </button>
                            <button id="stop-face-login-btn" class="btn btn-secondary w-100 py-2" style="display:none;">
                                <i class="bi bi-stop-circle"></i> 停止识别
                            </button>
                        </div>
                        
                        <!-- 注册标签页 -->
                        <div class="tab-pane fade" id="face-register" role="tabpanel">
                            <div class="text-center mb-3">
                                <p class="text-muted">首次使用请先注册</p>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="register-username" class="form-label">请输入您的真实姓名</label>
                                <input type="text" class="form-control" id="register-username" placeholder="例如：张三" maxlength="10">
                                <small class="form-text text-muted">2-10个字符</small>
                            </div>
                            
                            <!-- 摄像头预览 -->
                            <div class="position-relative mb-3">
                                <video id="face-register-video" width="100%" height="300" autoplay muted playsinline class="border rounded" style="background-color: #000;"></video>
                                <canvas id="face-register-canvas" class="position-absolute top-0 start-0 w-100 h-100" style="display:none;"></canvas>
                                <div id="face-register-status" class="position-absolute bottom-0 start-0 w-100 text-center py-2 bg-dark bg-opacity-75 text-white" style="display:none;">
                                    初始化中...
                                </div>
                            </div>
                            
                            <button id="face-register-btn" class="btn btn-success w-100 py-2 mb-2">
                                <i class="bi bi-camera"></i> 开始人脸注册
                            </button>
                            <button id="stop-face-register-btn" class="btn btn-secondary w-100 py-2" style="display:none;">
                                <i class="bi bi-stop-circle"></i> 停止注册
                            </button>
                        </div>
                    </div>
                    
                    <!-- 加载提示 -->
                    <div id="face-loading" class="text-center mt-3" style="display:none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <small class="text-muted ms-2">正在加载人脸识别模型...</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="home-screen" class="d-none">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm bg-light">
                        <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary rounded-circle p-1 me-2 text-white">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 fs-6" id="user-fullname">用户: </h5>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm bg-light">
                        <div class="card-body p-3">
                            <div class="process-select-container">
                                <label for="process-select" class="form-label">工序选择：</label>
                                <select class="form-select" id="process-select">
                                    <option value="wiring">绕线</option>
                                    <option value="embedding">嵌线</option>
                                    <option value="wiring_connect">接线</option>
                                    <option value="pressing">压装</option>
                                    <option value="stopper">车止口</option>
                                    <option value="immersion">浸漆</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-single-scan">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-qr-code-scan text-primary"></i>
                            <h5 class="text-primary">单个扫码</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-continuous-scan">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-repeat text-success"></i>
                            <h5 class="text-success">连续扫码</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-manual-scan">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-keyboard text-primary"></i>
                            <h5 class="text-primary">扫码枪/手动录入</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-product-query">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-search text-warning"></i>
                            <h5 class="text-warning">本月台账查询</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="leader-card">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-people text-info"></i>
                            <h5 class="text-info">组长功能</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-product-scan-query">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-qr-code text-info"></i>
                            <h5 class="text-info">产品扫码查询</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-inventory">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-box-seam text-secondary"></i>
                            <h5 class="text-secondary">扫码枪盘点录入</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-delete-records">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-trash text-danger"></i>
                            <h5 class="text-danger">删除记录</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-stamping-scan" onclick="handleStampingScan()" style="cursor: pointer;">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-qr-code-scan text-success"></i>
                            <h5 class="text-success">冲床型号扫描</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <a href="stamping.html" class="text-decoration-none" target="_blank">
                        <div class="card shadow-sm h-100">
                            <div class="card-body text-center p-4 home-card">
                                <i class="bi bi-hammer text-warning"></i>
                                <h5 class="text-warning">冲床计数监控</h5>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm h-100" id="card-stamping-ledger" onclick="handleStampingLedger()" style="cursor: pointer;">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-journal-text text-info"></i>
                            <h5 class="text-info">冲床台账查询</h5>
                        </div>
                    </div>
                </div>
                <div class="col-6" id="leader-functions-card" style="display:none;">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4 home-card">
                            <i class="bi bi-people text-purple"></i>
                            <h5 class="text-purple">组长功能</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下面保持不变 -->
        <div id="single-scan-screen" class="d-none">
            <div class="mb-3">
                <h3 class="text-center">单个扫码</h3>
                <p id="single-scan-process" class="current-process-display"></p>
            </div>
            <button class="btn btn-secondary mt-3 w-100" id="single-scan-back">返回</button>
        </div>

        <!-- 连续扫码屏幕 -->
        <div id="continuous-scan-screen" class="d-none">
            <div class="mb-3">
                <h3 class="text-center">连续扫码</h3>
                <p id="continuous-scan-process" class="current-process-display"></p>
            </div>
            <div class="mb-3" id="manual-multiline-input-container">
                <label for="manual-multiline-codes" class="form-label">手动输入（每行一条，支持多条同时上传）</label>
                <textarea class="form-control" id="manual-multiline-codes" rows="4" placeholder="每行输入一个产品编码"></textarea>
                <button class="btn btn-primary mt-2 w-100" id="manual-multiline-upload" type="button">手动上传</button>
            </div>
            <button class="btn btn-secondary mt-3 w-100" id="continuous-scan-back">返回</button>
        </div>

        <!-- 扫码枪/手动录入屏幕 -->
        <div id="manual-scan-screen" class="d-none">
            <div class="mb-3">
                <h3 class="text-center">扫码枪/手动录入</h3>
                <p id="manual-scan-process" class="current-process-display"></p>
            </div>
            <div class="mb-3" id="manual-scan-input-container">
                <label for="manual-scan-codes" class="form-label">手动输入（每行一条，支持多条同时上传）</label>
                <textarea class="form-control" id="manual-scan-codes" rows="4" placeholder="每行输入一个产品编码"></textarea>
                <button class="btn btn-primary mt-2 w-100" id="manual-scan-upload" type="button">手动上传</button>
            </div>
            <button class="btn btn-secondary mt-3 w-100" id="manual-scan-back">返回</button>
        </div>

        <!-- 扫码屏幕 -->
        <div id="scan-screen" class="d-none">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="text-center mb-3" id="scan-title">扫码</h3>
                    <div id="scanner-container" class="mb-3">
                        <video id="scanner-preview" style="width: 100%; max-height: 70vh;"></video>
                    </div>
                    <div id="scan-buttons" class="d-flex justify-content-between">
                        <button class="btn btn-danger" id="scan-stop">停止</button>
                        <button class="btn btn-primary d-none" id="scan-upload">上传</button>
                    </div>
                    <div id="scan-pending-list" class="mt-3 d-none">
                        <h5>待上传列表:</h5>
                        <ul class="list-group" id="pending-codes-list"></ul>
                        <div class="mt-2 text-end">
                            <span id="pending-count">0</span> 个产品
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查询屏幕 -->
        <div id="query-screen" class="d-none">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="text-center mb-3">本月台账查询</h3>
                    <div id="query-result">
                        <div class="list-group mb-3" id="process-list">
                            <!-- 工序列表将在这里动态生成 -->
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-3 w-100" id="query-back">返回</button>
                    
                    <!-- 本月流水账容器 -->
                    <div id="monthly-transactions-container" class="mt-4">
                        <!-- 流水账将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 删除记录屏幕 - 独立屏幕 -->
        <div id="delete-records-screen" class="d-none">
            <h3 class="text-center mb-3">删除记录</h3>
            <div id="delete-records-content">
                <!-- 删除记录内容将在这里动态生成 -->
            </div>
        </div>

        <!-- 产品型号列表屏幕 -->
        <div id="models-screen" class="d-none">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="text-center mb-3" id="models-title">型号列表</h3>
                    <div id="models-result">
                        <div class="list-group mb-3" id="model-list">
                            <!-- 型号列表将在这里动态生成 -->
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-3 w-100" id="models-back">返回</button>
                </div>
            </div>
        </div>

        <!-- 产品编码列表屏幕 -->
        <div id="products-screen" class="d-none">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="text-center mb-3" id="products-title">产品列表</h3>
                    <div id="products-result">
                        <div class="list-group mb-3" id="product-list">
                            <!-- 产品列表将在这里动态生成 -->
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-3 w-100" id="products-back">返回</button>
                </div>
            </div>
        </div>

        <!-- 产品详情弹窗 -->
        <div class="modal fade" id="product-detail-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">产品详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="product-detail-content">
                        <!-- 产品详情将在这里动态生成 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
    </div>

    <!-- 组长汇总查询界面 -->
    <div id="leader-summary-screen" class="d-none">
        <div class="container mt-3">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">组长功能</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-grid gap-2">
                                <button id="group-products-btn" class="btn btn-lg btn-primary">
                                    <i class="bi bi-boxes"></i> 查看汇总情况
                                </button>
                                <button id="assign-group-btn" class="btn btn-lg btn-warning">
                                    <i class="bi bi-diagram-3"></i> 为产品分配组别
                                </button>
                                <button id="push-settings-btn" class="btn btn-lg btn-info">
                                    <i class="bi bi-bell"></i> 推送通知设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-secondary" id="leader-back-btn">
                        <i class="bi bi-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 推送通知设置界面 -->
    <div id="push-settings-screen" class="d-none">
        <div class="container mt-3 mb-3">
            <div class="card" style="margin-bottom: 70px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-bell"></i> 推送通知设置</h5>
                </div>
                <div class="card-body">
                    
                    <!-- 推送说明 -->
                    <div class="alert alert-info" id="push-status-alert">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>钉钉推送通知</strong>
                                <p class="mb-0 mt-1 small">
                                    任务完成后将通过钉钉应用消息通知组长，您可以在下方设置中控制是否接收通知。
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 推送设置 -->
                    <div id="push-settings-form" class="d-none">
                        <h6 class="mb-3"><i class="bi bi-gear"></i> 通知设置</h6>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-push" checked>
                                <label class="form-check-label fw-bold" for="enable-push">
                                    推送总开关
                                </label>
                            </div>
                            <small class="text-muted">关闭后将不会收到任何推送通知</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-task-complete" checked>
                                <label class="form-check-label" for="enable-task-complete">
                                    任务完成通知
                                </label>
                            </div>
                            <small class="text-muted">小组成员完成任务时推送</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-daily-summary">
                                <label class="form-check-label" for="enable-daily-summary">
                                    每日汇总通知
                                </label>
                            </div>
                            <small class="text-muted">每天下午6点推送当日汇总（暂未开放）</small>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-abnormal-alert" checked>
                                <label class="form-check-label" for="enable-abnormal-alert">
                                    异常提醒
                                </label>
                            </div>
                            <small class="text-muted">发生异常情况时推送（暂未开放）</small>
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3"><i class="bi bi-moon"></i> 免打扰时间</h6>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="quiet-start-hour" class="form-label">开始时间</label>
                                <select id="quiet-start-hour" class="form-select">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22" selected>22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="quiet-end-hour" class="form-label">结束时间</label>
                                <select id="quiet-end-hour" class="form-select">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8" selected>08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                            </div>
                        </div>
                        <small class="text-muted">在免打扰时间内不会收到推送通知（默认 22:00 - 08:00）</small>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button id="save-push-settings-btn" class="btn btn-primary">
                                <i class="bi bi-save"></i> 保存设置
                            </button>
                            <button id="test-push-btn" class="btn btn-outline-secondary">
                                <i class="bi bi-send"></i> 发送测试通知
                            </button>
                        </div>
                    </div>
                    
                </div>
                <div class="card-footer">
                    <button class="btn btn-secondary" id="push-settings-back-btn">
                        <i class="bi bi-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 小组产品数量查询界面 -->
    <div id="group-products-screen" class="d-none">
        <div class="container mt-3 mb-3">
            <div class="card" style="margin-bottom: 70px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">小组产品数量查询</h5>
                </div>
                <div class="card-body">
                    <!-- 小组选择 -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="group-select" class="form-label fw-bold">选择小组</label>
                            <select id="group-select" class="form-select form-select-lg">
                                <option value="" selected>请选择小组</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 日期时间筛选 -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">时间范围</label>
                        <!-- 开始日期时间 - 不换行 -->
                        <div class="date-time-row mb-2">
                            <div>
                                <label for="start-date" class="form-label text-muted small">开始日期</label>
                            <input type="date" id="start-date" class="form-control">
                        </div>
                            <div>
                                <label for="start-time" class="form-label text-muted small">开始时间</label>
                                <input type="time" id="start-time" class="form-control" value="00:00" step="1">
                            </div>
                        </div>
                        <!-- 结束日期时间 - 不换行 -->
                        <div class="date-time-row">
                            <div>
                                <label for="end-date" class="form-label text-muted small">结束日期</label>
                            <input type="date" id="end-date" class="form-control">
                        </div>
                            <div>
                                <label for="end-time" class="form-label text-muted small">结束时间</label>
                                <input type="time" id="end-time" class="form-control" value="23:59" step="1">
                    </div>
                        </div>
                    </div>
                    
                    <!-- 筛选条件 -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">筛选条件</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="filter-box">
                                    <label for="employee-filter" class="form-label text-muted small mb-1">
                                        <i class="bi bi-person-fill"></i> 员工筛选
                                    </label>
                                    <select id="employee-filter" class="form-select">
                                        <option value="">全体员工</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="filter-box">
                                    <label for="model-filter" class="form-label text-muted small mb-1">
                                        <i class="bi bi-box-seam-fill"></i> 型号筛选（可多选）
                                    </label>
                                    <select id="model-filter" class="form-select" multiple="multiple" size="5" style="min-height: 100px;">
                                        <option value="" disabled>自动加载中...</option>
                                    </select>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-magic"></i> 
                                        自动显示当前条件下有数据的型号，按住Ctrl/Cmd可多选
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-6">
                            <button id="query-group-products-btn" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-search"></i> 查询
                            </button>
                        </div>
                        <div class="col-6">
                            <button id="export-excel-btn" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-file-earmark-excel"></i> 导出Excel
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div id="group-products-result" class="table-responsive">
                            <!-- 查询结果将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 固定在屏幕底部的返回按钮 -->
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background-color: white; border-top: 2px solid #dee2e6; padding: 0.75rem; z-index: 9999; box-shadow: 0 -3px 15px rgba(0,0,0,0.15);">
            <div class="container">
                <button class="btn btn-secondary w-100" id="group-products-back-btn" style="font-size: 0.9rem;">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
            </div>
        </div>
    </div>

    <!-- 员工产品数量查询界面 -->
    <div id="employee-products-screen" class="d-none">
        <div class="container mt-3">
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">员工产品数量查询</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="employee-group-select" class="form-label">选择小组</label>
                            <select id="employee-group-select" class="form-select form-select-lg mb-3">
                                <option value="" selected>请选择小组</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="employee-name" class="form-label">员工姓名（可选，留空则查询该小组全部）</label>
                            <input type="text" id="employee-name" class="form-control form-control-lg" placeholder="输入员工姓名">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="employee-start-date" class="form-label">开始日期</label>
                            <input type="date" id="employee-start-date" class="form-control">
                        </div>
                        <div class="col-6">
                            <label for="employee-end-date" class="form-label">结束日期</label>
                            <input type="date" id="employee-end-date" class="form-control">
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="query-employee-products-btn" class="btn btn-success">查询</button>
                    </div>
                    <div class="mt-3">
                        <div id="employee-products-result" class="table-responsive">
                            <!-- 查询结果将在这里显示 -->
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-secondary" id="employee-products-back-btn">
                        <i class="bi bi-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 为新产品分配小组界面 -->
    <div id="assign-group-screen" class="d-none">
        <div class="container mt-3 mb-3">
            <div class="card" style="margin-bottom: 80px;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">为产品分配小组</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="process-type-select" class="form-label">选择工序</label>
                            <select id="process-type-select" class="form-select form-select-lg mb-3">
                                <option value="" selected>请选择工序</option>
                                <option value="绕线">绕线</option>
                                <option value="嵌线">嵌线</option>
                                <option value="接线">接线</option>
                                <option value="压装">压装</option>
                                <option value="车止口">车止口</option>
                                <option value="浸漆">浸漆</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="product-model-select" class="form-label">选择产品型号（可多选）</label>
                            <select id="product-model-select" class="form-select form-select-lg mb-3" multiple size="5">
                                <option value="" disabled>请先选择工序</option>
                            </select>
                            <small class="text-muted">提示：按住Ctrl键可多选，显示的是未分配到小组的产品型号</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="assign-group-select" class="form-label">选择小组</label>
                            <select id="assign-group-select" class="form-select form-select-lg mb-3">
                                <option value="" selected>请先选择工序</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <button id="assign-group-submit-btn" class="btn btn-warning w-100">分配小组</button>
                        </div>
                        <div class="col-6">
                            <button id="view-assigned-btn" class="btn btn-info w-100">查看已分配</button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div id="assign-group-result" class="d-none">
                            <!-- 分配结果将在这里显示 -->
                        </div>
                    </div>
                    <div class="mt-3">
                        <div id="assigned-list-container" class="d-none">
                            <h6 class="text-muted mb-2">已分配的产品型号</h6>
                            <div id="assigned-list" class="list-group">
                                <!-- 已分配列表将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 固定在屏幕底部的操作按钮 - 在所有内容之上 -->
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background-color: white; border-top: 2px solid #dee2e6; padding: 0.75rem; z-index: 9999; box-shadow: 0 -3px 15px rgba(0,0,0,0.15);">
            <div class="container">
                <div class="d-flex gap-2">
                    <button class="btn btn-danger flex-grow-1" id="batch-delete-btn" disabled style="font-size: 0.9rem;">
                        批量删除 (<span id="selected-count-btn">0</span>)
                    </button>
                    <button class="btn btn-secondary flex-grow-1" id="assign-group-back-btn" style="font-size: 0.9rem;">
                        <i class="bi bi-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast提示 -->
    <div id="toast-container"></div>

        <!-- 单次扫码重复记录阻塞提示框 -->
        <div class="modal fade" id="duplicate-record-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">提示</h5>
                        <!-- 不提供右上角关闭，强制点击确认 -->
                    </div>
                    <div class="modal-body">
                        <div id="duplicate-record-message">该产品当前工序已存在记录，请勿重复录入。</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="duplicate-record-confirm">我知道了</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 冲床型号扫描模态框 -->
    <div class="modal fade" id="stamping-scan-modal" tabindex="-1" data-bs-backdrop="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🔨 冲床型号扫描</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        👤 当前员工：<strong id="stamping-current-employee">-</strong>
                    </div>
                    
                    <div id="stamping-last-device" style="display:none;" class="mb-3">
                        <button class="btn btn-success w-100" onclick="useLastStampingDevice()">
                            <i class="bi bi-arrow-repeat"></i> 使用上次设备：<span id="stamping-last-device-name"></span>
                        </button>
                        <div class="text-center my-2">或</div>
                    </div>
                    
                    <button class="btn btn-primary btn-lg w-100 mb-3" id="stamping-scan-device-btn">
                        <i class="bi bi-qr-code-scan"></i> 扫描设备二维码
                    </button>
                    
                    <button class="btn btn-success btn-lg w-100 mb-3" id="stamping-scan-model-btn" style="display:none;">
                        <i class="bi bi-box-seam"></i> 扫描型号二维码
                    </button>
                    
                    <div id="stamping-qr-reader" style="display:none;"></div>
                    
                    <div id="stamping-current-info" class="mt-3" style="display:none;">
                        <h6>📋 当前工作信息</h6>
                        <table class="table table-sm">
                            <tr><td>设备：</td><td id="stamping-info-device">-</td></tr>
                            <tr><td>型号：</td><td id="stamping-info-model">-</td></tr>
                            <tr><td>配置：</td><td id="stamping-info-sheets">-</td></tr>
                            <tr><td>今日完成：</td><td id="stamping-info-completed" class="text-success">-</td></tr>
                            <tr><td>当前进度：</td><td id="stamping-info-progress">-</td></tr>
                        </table>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" id="stamping-progress-bar" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" onclick="handoverStampingTask()">
                        <i class="bi bi-arrow-left-right"></i> 交接任务
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeStampingModal()">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 冲床台账查询模态框 -->
    <div class="modal fade" id="stamping-ledger-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">📓 冲床台账查询</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- 筛选条件 -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-funnel"></i> 筛选条件
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">员工姓名</label>
                                    <input type="text" class="form-control" id="ledger-employee" placeholder="全部员工">
                                    <small class="text-muted">普通员工只能查看自己</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">型号筛选（可多选）</label>
                                    <select id="ledger-model" class="form-select" multiple="multiple" size="4" style="min-height: 80px;">
                                        <option value="" disabled>请先选择日期...</option>
                                    </select>
                                    <small class="text-muted" id="model-count-hint">
                                        <i class="bi bi-magic"></i> 自动加载该时间范围内的型号，按住Ctrl/Cmd可多选
                                    </small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">开始日期</label>
                                    <input type="date" class="form-control" id="ledger-start-date">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">结束日期</label>
                                    <input type="date" class="form-control" id="ledger-end-date">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary w-100" onclick="queryStampingLedger()">
                                        <i class="bi bi-search"></i> 查询
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 汇总统计 -->
                    <div id="ledger-summary" style="display:none;">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="text-muted">记录数</h6>
                                        <h3 class="text-primary" id="ledger-count">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="text-muted">总片数</h6>
                                        <h3 class="text-info" id="ledger-total-sheets">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="text-muted">总完成</h6>
                                        <h3 class="text-success" id="ledger-total-completed">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="text-muted">平均每天</h6>
                                        <h3 class="text-warning" id="ledger-avg-daily">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="ledger-results" class="table-responsive">
                        <p class="text-center text-muted">请设置查询条件后点击查询</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="exportStampingLedger()">
                        <i class="bi bi-file-earmark-excel"></i> 导出Excel
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载JS库 -->
    <script src="js/bootstrap/bootstrap.bundle.min.js?v=5.3.0"></script>
    <script src="js/html5-qrcode.min.js?v=1.1"></script>
    <!-- face-api.js - 人脸识别库 (polyfill已在head中加载) -->
    <script src="js/libs/face-api.min.js?v=1.0"></script>
    <!-- SheetJS - Excel导出库 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jQuery和Select2可选加载，如果失败会使用原生多选框 -->
    <!-- 注释掉CDN资源，减少移动端加载时间和避免网络阻塞
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    -->
    <!-- 加载状态指示器 -->
    <script src="js/loading-indicator.js?v=1.0"></script>
    <!-- 推送设置管理模块 -->
    <script src="js/push-manager.js?v=1.6"></script>
    <script src="js/app-new.js?v=3.42"></script>
    <script src="js/push-settings-ui.js?v=4.4"></script>
    <!-- 加载补丁脚本 -->
    <script src="patches/fix-scan-issues.js?v=1.1"></script>
    <!-- 加载iOS修复补丁 -->
    <script src="patches/ios-fix.js?v=1.2"></script>
    <!-- 加载扫码性能优化补丁 -->
    <script src="patches/scan-performance.js?v=1.0"></script>
    
    <!-- PWA安装脚本 -->
    <script>
    // Service Worker由push-manager.js统一管理
    console.log('[PWA] Service Worker由推送管理器统一管理');

    // 添加"添加到主屏幕"提示
    let deferredPrompt;
    const addBtn = document.getElementById('pwa-install-btn');
    const promptContainer = document.getElementById('pwa-install-prompt');

    window.addEventListener('beforeinstallprompt', (e) => {
        // 阻止Chrome 67及更早版本自动显示安装提示
        e.preventDefault();
        // 存储事件以便稍后触发
        deferredPrompt = e;
        // 显示我们的自定义"添加到主屏幕"提示（存在时）
        if (promptContainer) {
            promptContainer.style.display = 'block';
        }
        
        if (addBtn) {
            addBtn.addEventListener('click', (e) => {
                // 隐藏我们的用户界面，显示"添加到主屏幕"对话框
                if (promptContainer) {
                    promptContainer.style.display = 'none';
                }
                // 显示安装提示
                deferredPrompt.prompt();
                // 等待用户回应提示
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('用户接受了安装提示');
                    } else {
                        console.log('用户拒绝了安装提示');
                    }
                    deferredPrompt = null;
                });
            });
        }
    });
    
    // 在iOS设备上显示安装提示
    // 使用已经在其他地方定义的isIOS变量（需存在时才使用）
    if (typeof isIOS !== 'undefined' && isIOS && !("standalone" in window.navigator && window.navigator.standalone)) {
        if (promptContainer) {
            promptContainer.style.display = 'block';
        }
        
        // 如果是iOS设备且当前是HTTPS页面，则可能需要证书
        if (isIOS && window.location.protocol === 'https:') {
            // 检查是否已经关闭过提示（保存在本地存储中）
            if (localStorage.getItem('ios_cert_dismissed') !== 'true') {
                const iosCertPrompt = document.getElementById('ios-cert-prompt');
                if (iosCertPrompt) {
                    iosCertPrompt.style.display = 'block';
                    // 添加关闭按钮事件
                    const closeBtn = iosCertPrompt.querySelector('.btn-close');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function() {
                            localStorage.setItem('ios_cert_dismissed', 'true');
                        });
                    }
                }
            }
        }
    }
    </script>
    
    <!-- Bootstrap 验证 -->
    <script>
    // 验证Bootstrap加载
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof bootstrap !== 'undefined') {
            console.log('✅ Bootstrap 5.3.0 已加载');
            console.log('✅ Bootstrap Tab功能可用:', typeof bootstrap.Tab);
        } else {
            console.error('❌ Bootstrap未加载');
        }
    });
    </script>
    
    <!-- 人脸识别模块 - 最后加载，确保所有依赖都已准备好 -->
    <script src="js/face-recognition.js?v=1.3"></script>
</body>
</html>
