# 📱 Web Push推送通知使用指南

## 🎯 功能概述

完整的Web Push推送系统已经部署完成！组长可以：
- ✅ 在浏览器**关闭**时也能收到推送通知
- ✅ 小组成员扫码完成任务时自动推送
- ✅ 自定义推送设置（开关、免打扰时间）
- ✅ 多设备订阅支持（手机、电脑同时订阅）

---

## 🚀 快速开始（组长必读）

### 第1步：登录系统

1. 打开网站：`https://www.saby.uno:444`
2. 使用人脸识别或姓名登录
3. 进入主页

### 第2步：开启推送通知

1. 点击主页的 **"组长功能"** 卡片
2. 点击 **"推送通知设置"** 按钮（蓝色，带铃铛图标）
3. 点击 **"开启推送通知"** 大按钮
4. 浏览器会弹出权限请求，**点击"允许"**
5. 稍等片刻，显示 **"✅ 推送通知已开启"**

### 第3步：测试推送（可选）

1. 在推送设置页面，滚动到底部
2. 点击 **"发送测试通知"** 按钮
3. 检查是否收到测试通知

### 第4步：调整设置（可选）

- **推送总开关**：关闭后不会收到任何通知
- **任务完成通知**：默认开启
- **免打扰时间**：默认 22:00-08:00（可调整）

---

## 📋 使用场景

### 场景1：员工扫码完成任务

**流程**：
1. 小组成员使用扫码枪或手动扫码
2. 扫码成功后，系统自动识别产品所属小组
3. **自动推送通知给该小组的组长**
4. 组长手机/电脑收到通知（即使浏览器关闭）

**通知内容示例**：
```
📦 绕线小组一 新任务完成
张三 完成了 TEST-001 × 5
点击查看详情
```

### 场景2：多设备订阅

**组长可以同时在手机和电脑订阅**：
1. 手机浏览器：打开网站 → 组长功能 → 推送设置 → 开启
2. 电脑浏览器：打开网站 → 组长功能 → 推送设置 → 开启
3. 两个设备都会收到通知！

---

## ⚙️ 推送设置说明

### 通知类型

| 类型 | 说明 | 状态 |
|------|------|------|
| 任务完成通知 | 小组成员完成任务时推送 | ✅ 已开放 |
| 每日汇总通知 | 每天下午6点推送当日汇总 | ⏳ 暂未开放 |
| 异常提醒 | 发生异常情况时推送 | ⏳ 暂未开放 |

### 免打扰时间

**作用**：在免打扰时间内不会收到推送通知

**默认设置**：22:00 - 08:00（晚上10点到早上8点）

**如何调整**：
1. 组长功能 → 推送通知设置
2. 滚动到 "免打扰时间" 部分
3. 选择开始和结束时间
4. 点击 "保存设置"

---

## 📱 移动端使用

### Android手机（推荐）

#### 支持的浏览器
- ✅ Chrome 浏览器（推荐）
- ✅ Edge 浏览器
- ✅ Firefox 浏览器
- ⚠️ 部分国产浏览器可能不支持

#### 开启步骤
1. 使用**普通模式**（不是无痕模式）
2. 打开网站，登录
3. 组长功能 → 推送通知设置
4. 点击"开启推送通知"
5. 允许通知权限

#### 系统设置（重要！）
除了网站权限，还需要检查系统设置：

**步骤**：
1. 手机**系统设置** → **应用管理**
2. 找到 **Chrome**（或你使用的浏览器）
3. **权限** → **通知** → 确保是"允许"
4. **通知类别** → 确保"网站"类别是开启的

**小米/红米**：
- 设置 → 通知与控制中心 → Chrome → 开启所有通知类型

**华为/荣耀**：
- 设置 → 通知 → Chrome → 允许通知 + 横幅 + 锁屏显示

### iPhone（iOS 16.4+）

#### 支持
- ✅ Safari 浏览器（iOS 16.4 及以上版本）
- ❌ 老版本iOS不支持

#### 开启步骤
1. 打开 Safari，访问网站
2. 组长功能 → 推送通知设置
3. 点击"开启推送通知"
4. 允许通知权限

---

## 🔧 常见问题

### Q1: 点击"开启推送通知"后没有反应？

**可能原因**：
- 浏览器不支持
- 使用了无痕模式
- 系统权限未开启

**解决方法**：
1. 检查浏览器版本（Chrome 60+）
2. 退出无痕模式，使用普通模式
3. 检查手机系统设置中的通知权限
4. 刷新页面重试

### Q2: 已经开启但收不到通知？

**排查步骤**：

**1. 检查订阅状态**
- 组长功能 → 推送通知设置
- 看是否显示"✅ 推送通知已开启"
- 如果不是，重新开启

**2. 检查推送总开关**
- 确保"推送总开关"是开启的
- 确保"任务完成通知"是开启的

**3. 检查免打扰时间**
- 当前时间是否在免打扰时间内
- 如果是，请等到非免打扰时间测试

**4. 发送测试通知**
- 点击"发送测试通知"按钮
- 如果测试通知能收到，说明功能正常
- 如果收不到，检查系统设置

**5. 检查产品分配**
- 该产品是否分配给了你的小组
- 只有分配给你小组的产品才会推送
- 在"为产品分配组别"中检查

### Q3: 电脑能收到，手机收不到？

**原因**：手机系统权限设置比电脑严格

**解决**：
1. 检查手机浏览器的通知权限
2. 检查手机系统设置中的通知权限
3. 关闭省电模式或将浏览器加入白名单
4. 关闭勿扰模式

### Q4: 浏览器关闭后能收到吗？

**Android Chrome**：✅ 能收到（浏览器完全关闭也能收到）

**电脑 Chrome**：✅ 能收到（浏览器完全关闭也能收到）

**iPhone Safari**：⚠️ 需要iOS 16.4+，且行为可能因版本而异

**其他浏览器**：看浏览器支持情况

### Q5: 如何关闭推送通知？

**方法1：在网站内关闭**
1. 组长功能 → 推送通知设置
2. 点击"关闭推送通知"按钮

**方法2：浏览器设置**
1. 浏览器设置 → 网站设置 → 通知
2. 找到 `www.saby.uno`
3. 改为"阻止"

**方法3：关闭总开关**
1. 组长功能 → 推送通知设置
2. 关闭"推送总开关"
3. 保持订阅但暂时不接收通知

### Q6: 通知太多，如何减少？

**方法1：调整免打扰时间**
- 扩大免打扰时间范围
- 例如设置为 20:00 - 10:00

**方法2：临时关闭**
- 关闭"推送总开关"
- 需要时再开启

---

## 🎯 管理员操作指南

### 查看推送统计

**数据库查询**：
```sql
-- 查看所有组长的推送统计
SELECT * FROM push_stats;

-- 查看某个组长的推送日志
SELECT * FROM push_logs 
WHERE user_name = '方辉' 
ORDER BY sent_at DESC 
LIMIT 20;

-- 查看推送成功率
SELECT 
    user_name,
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'sent' THEN 1 END) as success,
    COUNT(CASE WHEN status = 'failed' THEN 1 END) as failed
FROM push_logs
GROUP BY user_name;
```

### 手动发送测试推送

**API调用**：
```bash
curl -X POST "http://127.0.0.1:8002/api/push/test" \
  -H "Content-Type: application/json" \
  -d '{
    "user_name": "方辉",
    "group_name": "测试小组"
  }'
```

### 查看订阅列表

```sql
-- 查看所有活跃订阅
SELECT 
    user_name,
    COUNT(*) as subscription_count,
    MAX(created_at) as latest_subscription
FROM push_subscriptions
WHERE is_active = TRUE
GROUP BY user_name
ORDER BY latest_subscription DESC;
```

---

## 🔐 隐私和安全

### 推送数据

**包含的信息**：
- 员工姓名
- 产品型号
- 数量
- 工序名称

**不包含的信息**：
- 具体产品编码
- 详细时间戳
- 其他敏感信息

### 数据存储

- ✅ 订阅信息加密存储
- ✅ 仅组长本人可以管理自己的订阅
- ✅ 推送日志保留30天后自动清理
- ✅ 符合GDPR和隐私保护要求

---

## 📞 技术支持

### 遇到问题？

1. **查看本指南的常见问题部分**
2. **联系系统管理员**
3. **提供以下信息**：
   - 使用的设备（手机/电脑）
   - 浏览器名称和版本
   - 具体的错误信息或截图
   - 操作步骤

### 功能建议

欢迎提出功能建议和改进意见！

---

## 📝 更新日志

### v1.0.0 (2025-11-16)
- ✅ 初始版本发布
- ✅ 支持任务完成推送
- ✅ 支持多设备订阅
- ✅ 支持免打扰时间设置
- ✅ 支持推送总开关
- ✅ 移动端兼容性优化

---

## 🎓 技术说明（开发者）

### 技术栈

**后端**：
- FastAPI
- pywebpush
- PostgreSQL

**前端**：
- Service Worker
- Push API
- Notification API

**协议**：
- Web Push Protocol (RFC 8030)
- VAPID (RFC 8292)

### API端点

```
GET  /api/push/vapid-public-key    获取VAPID公钥
POST /api/push/subscribe            订阅推送
POST /api/push/unsubscribe          取消订阅
GET  /api/push/status               获取订阅状态
GET  /api/push/settings             获取推送设置
PUT  /api/push/settings             更新推送设置
POST /api/push/test                 发送测试推送
GET  /api/push/logs                 获取推送日志
```

### 数据库表

```
push_subscriptions      推送订阅表
push_settings           推送设置表
push_logs               推送日志表
```

### 缓存策略

Service Worker采用**网络优先**策略：
- HTML/JS/CSS 不缓存，直接走网络
- 图标文件使用缓存
- 不影响程序更新

---

**祝使用愉快！** 📱✨
